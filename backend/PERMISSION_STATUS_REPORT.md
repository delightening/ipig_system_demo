# å„è§’è‰²æ¬Šé™ç‹€æ…‹æª¢æŸ¥å ±å‘Š

## éœ€æ±‚æ‘˜è¦

æ ¹æ“šç”¨æˆ¶éœ€æ±‚ï¼Œä»¥ä¸‹ç‚ºå„è§’è‰²æ‡‰å…·å‚™çš„æ¬Šé™ï¼š

### 1. IACUC_STAFF (åŸ·è¡Œç§˜æ›¸)
- âœ… **ä¿å­˜è‰ç¨¿æ™‚å³å¯æŸ¥çœ‹è¨ˆç•«å…§å®¹**
- âœ… **å¯æŒ‡æ´¾ EXPERIMENT_STAFF ç‚º co-editor**

### 2. PI (è¨ˆç•«ä¸»æŒäºº) èˆ‡ CLIENT (å§”è¨—äºº)
æ‡‰å…·å‚™ä»¥ä¸‹æ¬Šé™ï¼š
- âœ… æ’°å¯«è¨ˆç•«ã€ä¿®æ”¹ã€æäº¤
- âœ… å¯è¦‹è¨ˆç•«å…§ä¹‹å¯¦é©—å‹•ç‰©è³‡æ–™ã€ç´€éŒ„
- âœ… ä¸Šå‚³é™„ä»¶ã€ä¸‹è¼‰é™„ä»¶ã€åˆªé™¤é™„ä»¶ã€æŸ¥çœ‹é™„ä»¶
- âœ… åˆªé™¤è¨ˆç•«ã€å»ºç«‹è¨ˆç•«ã€æŸ¥çœ‹è‡ªå·±çš„è¨ˆç•«ã€æäº¤è¨ˆç•«ã€ç·¨è¼¯è¨ˆç•«
- âœ… æŸ¥çœ‹å¯©æŸ¥æ„è¦‹
- âœ… æŸ¥çœ‹è¨ˆç•«æ›¸ç‰ˆæœ¬æ­·å²ã€é‚„åŸç‰ˆæœ¬
- âœ… åŒ¯å‡ºè¨ˆç•«å…§è±¬éš»çš„æ‰‹è¡“ç´€éŒ„ã€æ‰€æœ‰è³‡æ–™ã€ç—…æ­·ã€è©¦é©—ç´€éŒ„èˆ‡è§€å¯Ÿç´€éŒ„
- âœ… æŸ¥çœ‹è¨ˆç•«å…§è±¬éš»ç—…ç†å ±å‘Š
- âœ… æŸ¥çœ‹è¨ˆç•«å…§è±¬éš»ã€åŒ¯å‡ºè±¬éš»è³‡æ–™
- âœ… æŸ¥çœ‹è¨ˆç•«å…§è±¬éš»çš„æ‰‹è¡“ã€ç–«è‹—ã€çŠ§ç‰²ã€é«”é‡ã€è§€å¯Ÿç­‰ç´€éŒ„

### 3. CLIENT (å§”è¨—äºº) ç‰¹æ®Šæ¬Šé™
- âœ… **å§”è¨—å–®ä½ä¸»ç®¡ï¼ˆå§”è¨—äººï¼‰å¯è¦‹å…¶è½„ä¸‹æ‰€æœ‰äººå“¡ä¹‹è¨ˆç•«èˆ‡è±¬éš»**

### 4. EXPERIMENT_STAFF (è©¦é©—å·¥ä½œäººå“¡)
- âœ… **å¯è¢«æŒ‡æ´¾ç‚º co-editor**
- âœ… **å”åŠ©è¨ˆç•«ä¸»æŒäººã€å§”è¨—äººæ’°å¯«è¨ˆç•«**

---

## ç•¶å‰æ¬Šé™ç‹€æ…‹æª¢æŸ¥

### âœ… IACUC_STAFF (åŸ·è¡Œç§˜æ›¸)

#### AUP å”è­°ç›¸é—œæ¬Šé™
| æ¬Šé™ | ç‹€æ…‹ | èªªæ˜ |
|-----|:---:|------|
| `aup.protocol.view_all` | âœ… | æŸ¥çœ‹æ‰€æœ‰è¨ˆç•« |
| `aup.protocol.view_own` | âœ… | æŸ¥çœ‹è‡ªå·±çš„è¨ˆç•« |
| `aup.protocol.create` | âœ… | å»ºç«‹è¨ˆç•« |
| `aup.protocol.edit` | âœ… | ç·¨è¼¯è¨ˆç•« |
| `aup.protocol.submit` | âœ… | æäº¤è¨ˆç•« |
| `aup.protocol.change_status` | âœ… | è®Šæ›´ç‹€æ…‹ |
| `aup.review.view` | âœ… | æŸ¥çœ‹å¯©æŸ¥æ„è¦‹ |
| `aup.review.assign` | âœ… | æŒ‡æ´¾å¯©æŸ¥äººå“¡ |
| `aup.attachment.upload` | âœ… | ä¸Šå‚³é™„ä»¶ |
| `aup.attachment.view` | âœ… | æŸ¥çœ‹é™„ä»¶ |
| `aup.attachment.download` | âœ… | ä¸‹è¼‰é™„ä»¶ |
| `aup.attachment.delete` | âœ… | åˆªé™¤é™„ä»¶ |
| `aup.version.view` | âœ… | æŸ¥çœ‹ç‰ˆæœ¬æ­·å² |
| `aup.version.restore` | âœ… | é‚„åŸç‰ˆæœ¬ |

**çµè«–**ï¼šIACUC_STAFF å…·å‚™å®Œæ•´çš„ AUP æ¬Šé™ âœ…

#### âš ï¸ ç¼ºå¤±åŠŸèƒ½
- âŒ **ç„¡æ³•æŒ‡æ´¾ EXPERIMENT_STAFF ç‚º co-editor**
  - åŸå› ï¼š`protocol_role` enum åªæœ‰ `PI` å’Œ `CLIENT`ï¼Œæ²’æœ‰ `CO_EDITOR`
  - åŸå› ï¼šæ²’æœ‰æŒ‡æ´¾ co-editor çš„ API åŠŸèƒ½

---

### âŒ PI (è¨ˆç•«ä¸»æŒäºº)

#### AUP å”è­°ç›¸é—œæ¬Šé™
| æ¬Šé™ | ç‹€æ…‹ | èªªæ˜ |
|-----|:---:|------|
| `aup.protocol.view_own` | âŒ | **æœªåˆ†é…** |
| `aup.protocol.create` | âŒ | **æœªåˆ†é…** |
| `aup.protocol.edit` | âŒ | **æœªåˆ†é…** |
| `aup.protocol.delete` | âŒ | **æœªåˆ†é…** |
| `aup.protocol.submit` | âŒ | **æœªåˆ†é…** |
| `aup.review.view` | âŒ | **æœªåˆ†é…** |
| `aup.attachment.upload` | âŒ | **æœªåˆ†é…** |
| `aup.attachment.view` | âŒ | **æœªåˆ†é…** |
| `aup.attachment.download` | âŒ | **æœªåˆ†é…** |
| `aup.attachment.delete` | âŒ | **æœªåˆ†é…** |
| `aup.version.view` | âŒ | **æœªåˆ†é…** |
| `aup.version.restore` | âŒ | **æœªåˆ†é…** |

#### è±¬éš»ç®¡ç†ç›¸é—œæ¬Šé™
| æ¬Šé™ | ç‹€æ…‹ | èªªæ˜ |
|-----|:---:|------|
| `pig.pig.view_project` | âŒ | **æœªåˆ†é…** |
| `pig.pig.export` | âŒ | **æœªåˆ†é…** |
| `pig.record.view` | âŒ | **æœªåˆ†é…** |
| `pig.record.observation` | âŒ | **æœªåˆ†é…** |
| `pig.record.surgery` | âŒ | **æœªåˆ†é…** |
| `pig.record.weight` | âŒ | **æœªåˆ†é…** |
| `pig.record.vaccine` | âŒ | **æœªåˆ†é…** |
| `pig.record.sacrifice` | âŒ | **æœªåˆ†é…** |
| `pig.export.medical` | âœ… | å·²åˆ†é… |
| `pig.export.observation` | âœ… | å·²åˆ†é… |
| `pig.export.surgery` | âœ… | å·²åˆ†é… |
| `pig.export.experiment` | âŒ | **æœªåˆ†é…** |
| `pig.pathology.view` | âŒ | **æœªåˆ†é…** |

**çµè«–**ï¼šPI è§’è‰²**ç¼ºå°‘å¤§éƒ¨åˆ† AUP æ¬Šé™** âŒ

---

### âŒ CLIENT (å§”è¨—äºº)

#### AUP å”è­°ç›¸é—œæ¬Šé™
| æ¬Šé™ | ç‹€æ…‹ | èªªæ˜ |
|-----|:---:|------|
| `aup.protocol.view_own` | âŒ | **æœªåˆ†é…** |
| `aup.protocol.create` | âŒ | **æœªåˆ†é…**ï¼ˆä¾éœ€æ±‚æ‡‰ä¸èƒ½å»ºç«‹ï¼‰ |
| `aup.protocol.edit` | âŒ | **æœªåˆ†é…** |
| `aup.protocol.delete` | âŒ | **æœªåˆ†é…**ï¼ˆä¾éœ€æ±‚æ‡‰ä¸èƒ½åˆªé™¤ï¼‰ |
| `aup.protocol.submit` | âŒ | **æœªåˆ†é…** |
| `aup.review.view` | âŒ | **æœªåˆ†é…** |
| `aup.attachment.upload` | âŒ | **æœªåˆ†é…** |
| `aup.attachment.view` | âŒ | **æœªåˆ†é…** |
| `aup.attachment.download` | âŒ | **æœªåˆ†é…** |
| `aup.attachment.delete` | âŒ | **æœªåˆ†é…** |
| `aup.version.view` | âŒ | **æœªåˆ†é…** |
| `aup.version.restore` | âŒ | **æœªåˆ†é…** |

#### è±¬éš»ç®¡ç†ç›¸é—œæ¬Šé™
| æ¬Šé™ | ç‹€æ…‹ | èªªæ˜ |
|-----|:---:|------|
| `pig.pig.view_project` | âŒ | **æœªåˆ†é…** |
| `pig.pig.export` | âŒ | **æœªåˆ†é…** |
| `pig.record.view` | âŒ | **æœªåˆ†é…** |
| `pig.record.observation` | âŒ | **æœªåˆ†é…** |
| `pig.record.surgery` | âŒ | **æœªåˆ†é…** |
| `pig.record.weight` | âŒ | **æœªåˆ†é…** |
| `pig.record.vaccine` | âŒ | **æœªåˆ†é…** |
| `pig.record.sacrifice` | âŒ | **æœªåˆ†é…** |
| `pig.export.medical` | âœ… | å·²åˆ†é… |
| `pig.export.observation` | âœ… | å·²åˆ†é… |
| `pig.export.surgery` | âœ… | å·²åˆ†é… |
| `pig.export.experiment` | âŒ | **æœªåˆ†é…** |
| `pig.pathology.view` | âŒ | **æœªåˆ†é…** |

**çµè«–**ï¼šCLIENT è§’è‰²**ç¼ºå°‘å¤§éƒ¨åˆ† AUP æ¬Šé™** âŒ

#### âš ï¸ ç‰¹æ®Šéœ€æ±‚ç¼ºå¤±
- âŒ **å§”è¨—å–®ä½ä¸»ç®¡å¯è¦‹è½„ä¸‹æ‰€æœ‰äººå“¡ä¹‹è¨ˆç•«èˆ‡è±¬éš»**
  - åŸå› ï¼šéœ€è¦åŸºæ–¼ `organization` æ¬„ä½çš„æ¬Šé™æ§åˆ¶
  - åŸå› ï¼šéœ€è¦ç‰¹æ®Šçš„è³‡æ–™ç¯„åœæŸ¥è©¢é‚è¼¯

---

### âŒ EXPERIMENT_STAFF (è©¦é©—å·¥ä½œäººå“¡)

#### AUP å”è­°ç›¸é—œæ¬Šé™
| æ¬Šé™ | ç‹€æ…‹ | èªªæ˜ |
|-----|:---:|------|
| AUP ç›¸é—œæ¬Šé™ | âŒ | **å®Œå…¨æ²’æœ‰ AUP æ¬Šé™** |

#### âš ï¸ ç¼ºå¤±åŠŸèƒ½
- âŒ **ç„¡æ³•è¢«æŒ‡æ´¾ç‚º co-editor**
  - åŸå› ï¼š`protocol_role` enum åªæœ‰ `PI` å’Œ `CLIENT`ï¼Œæ²’æœ‰ `CO_EDITOR`
  - åŸå› ï¼šæ²’æœ‰æŒ‡æ´¾ co-editor çš„ API åŠŸèƒ½
- âŒ **ç„¡æ³•å”åŠ©æ’°å¯«è¨ˆç•«**
  - åŸå› ï¼šæ²’æœ‰å”è­°ç·¨è¼¯æ¬Šé™
  - åŸå› ï¼šç„¡æ³•æŸ¥çœ‹å”è­°å…§å®¹

---

## è³‡æ–™åº«çµæ§‹å•é¡Œ

### âŒ `protocol_role` enum ä¸æ”¯æ´ CO_EDITOR

**ç•¶å‰å®šç¾©** (`backend/migrations/002_extend_schema.sql`):
```sql
CREATE TYPE protocol_role AS ENUM ('PI', 'CLIENT');
```

**å•é¡Œ**ï¼šæ²’æœ‰ `CO_EDITOR` é¸é …

**å½±éŸ¿**ï¼š
- ç„¡æ³•åœ¨ `user_protocols` è¡¨ä¸­æŒ‡æ´¾ EXPERIMENT_STAFF ç‚º co-editor
- ç„¡æ³•è­˜åˆ¥èª°æ˜¯æŸå€‹å”è­°çš„ co-editor

---

## éœ€è¦ä¿®å¾©çš„å•é¡Œæ¸…å–®

### ğŸ”´ é«˜å„ªå…ˆç´šï¼ˆå¿…é ˆä¿®å¾©ï¼‰

1. **ç‚º PI è§’è‰²åˆ†é… AUP æ¬Šé™**
   - [ ] `aup.protocol.view_own`
   - [ ] `aup.protocol.create`
   - [ ] `aup.protocol.edit`
   - [ ] `aup.protocol.delete`
   - [ ] `aup.protocol.submit`
   - [ ] `aup.review.view`
   - [ ] `aup.attachment.upload`
   - [ ] `aup.attachment.view`
   - [ ] `aup.attachment.download`
   - [ ] `aup.attachment.delete`
   - [ ] `aup.version.view`
   - [ ] `aup.version.restore`

2. **ç‚º PI è§’è‰²åˆ†é…è±¬éš»ç®¡ç†æ¬Šé™**
   - [ ] `pig.pig.view_project`
   - [ ] `pig.pig.export`
   - [ ] `pig.record.view`
   - [ ] `pig.record.observation`
   - [ ] `pig.record.surgery`
   - [ ] `pig.record.weight`
   - [ ] `pig.record.vaccine`
   - [ ] `pig.record.sacrifice`
   - [ ] `pig.export.experiment`
   - [ ] `pig.pathology.view`

3. **ç‚º CLIENT è§’è‰²åˆ†é… AUP æ¬Šé™**ï¼ˆåƒ…æŸ¥çœ‹èˆ‡é™„ä»¶ï¼‰
   - [ ] `aup.protocol.view_own`
   - [ ] `aup.review.view`
   - [ ] `aup.attachment.upload`
   - [ ] `aup.attachment.view`
   - [ ] `aup.attachment.download`
   - [ ] `aup.attachment.delete`
   - [ ] `aup.version.view`

4. **ç‚º CLIENT è§’è‰²åˆ†é…è±¬éš»ç®¡ç†æ¬Šé™**ï¼ˆåƒ…æŸ¥çœ‹ï¼‰
   - [ ] `pig.pig.view_project`
   - [ ] `pig.pig.export`
   - [ ] `pig.record.view`
   - [ ] `pig.export.experiment`
   - [ ] `pig.pathology.view`

5. **å¯¦ç¾ Co-Editor æ©Ÿåˆ¶**
   - [ ] æ“´å±• `protocol_role` enum æ”¯æ´ `CO_EDITOR`
   - [ ] å‰µå»º migration æ·»åŠ  `CO_EDITOR` åˆ° enum
   - [ ] å¯¦ç¾æŒ‡æ´¾ co-editor çš„ API
   - [ ] ç‚º EXPERIMENT_STAFF åˆ†é…å”è­°ç·¨è¼¯æ¬Šé™ï¼ˆç•¶è¢«æŒ‡æ´¾ç‚º co-editor æ™‚ï¼‰

### ğŸŸ¡ ä¸­å„ªå…ˆç´šï¼ˆæ‡‰è©²å¯¦ç¾ï¼‰

6. **å§”è¨—å–®ä½ä¸»ç®¡ç‰¹æ®Šæ¬Šé™**
   - [ ] å¯¦ç¾åŸºæ–¼ `organization` çš„è³‡æ–™ç¯„åœæŸ¥è©¢
   - [ ] å§”è¨—å–®ä½ä¸»ç®¡å¯æŸ¥çœ‹è½„ä¸‹æ‰€æœ‰äººå“¡ä¹‹è¨ˆç•«
   - [ ] å§”è¨—å–®ä½ä¸»ç®¡å¯æŸ¥çœ‹è½„ä¸‹æ‰€æœ‰äººå“¡ä¹‹è±¬éš»

### ğŸŸ¢ ä½å„ªå…ˆç´šï¼ˆå¯ä»¥å¾ŒçºŒå„ªåŒ–ï¼‰

7. **æ¬Šé™æª¢æŸ¥é‚è¼¯å„ªåŒ–**
   - [ ] æª¢æŸ¥è‰ç¨¿ç‹€æ…‹ä¸‹çš„æ¬Šé™æ§åˆ¶
   - [ ] IACUC_STAFF åœ¨ä¿å­˜è‰ç¨¿æ™‚å³å¯æŸ¥çœ‹ï¼ˆç›®å‰å·²æœ‰ `view_all`ï¼‰

---

## å·²å®Œæˆçš„ä¿®å¾©

âœ… **Migration 035 å·²å‰µå»º**: `035_assign_pi_and_client_permissions.sql`

### ä¿®å¾©å…§å®¹ï¼š

1. âœ… **æ“´å±• protocol_role enum æ”¯æ´ CO_EDITOR**
   - å·²æ–°å¢ `CO_EDITOR` å€¼åˆ° `protocol_role` enum
   - å·²æ›´æ–° Rust æ¨¡å‹ `ProtocolRole` enum

2. âœ… **ç‚º PI è§’è‰²åˆ†é… AUP å”è­°æ¬Šé™**
   - `aup.protocol.view_own`, `create`, `edit`, `delete`, `submit`
   - `aup.review.view`
   - `aup.attachment.*` (upload, view, download, delete)
   - `aup.version.view`, `restore`

3. âœ… **ç‚º CLIENT è§’è‰²åˆ†é… AUP å”è­°æ¬Šé™**ï¼ˆåƒ…æŸ¥çœ‹å’Œé™„ä»¶ï¼‰
   - `aup.protocol.view_own`
   - `aup.review.view`
   - `aup.attachment.*` (upload, view, download, delete)
   - `aup.version.view`

4. âœ… **ç‚º PI è§’è‰²åˆ†é…è±¬éš»ç®¡ç†æ¬Šé™**
   - `pig.pig.view_project`, `export`
   - `pig.record.view`, `observation`, `surgery`, `weight`, `vaccine`, `sacrifice`
   - `pig.export.experiment`
   - `pig.pathology.view`

5. âœ… **ç‚º CLIENT è§’è‰²åˆ†é…è±¬éš»ç®¡ç†æ¬Šé™**ï¼ˆåƒ…æŸ¥çœ‹ï¼‰
   - `pig.pig.view_project`, `export`
   - `pig.record.view`
   - `pig.export.experiment`
   - `pig.pathology.view`

### å¾…å¯¦ç¾çš„åŠŸèƒ½ï¼ˆæ‡‰ç”¨ç¨‹å¼é‚è¼¯å±¤ï¼‰ï¼š

âš ï¸ **ä»¥ä¸‹åŠŸèƒ½éœ€è¦åœ¨æ‡‰ç”¨ç¨‹å¼é‚è¼¯å±¤å¯¦ç¾**ï¼š

1. **Co-Editor æŒ‡æ´¾æ©Ÿåˆ¶**
   - å‰µå»º API ç«¯é»ä¾› IACUC_STAFF æŒ‡æ´¾ EXPERIMENT_STAFF ç‚º co-editor
   - æ›´æ–° `user_protocols` è¡¨ï¼Œè¨­å®š `role_in_protocol = 'CO_EDITOR'`
   - æ¬Šé™æª¢æŸ¥é‚è¼¯ï¼šç•¶ EXPERIMENT_STAFF è¢«æŒ‡æ´¾ç‚º co-editor æ™‚ï¼Œæ‡‰å…è¨±ç·¨è¼¯å”è­°

2. **å§”è¨—å–®ä½ä¸»ç®¡ç‰¹æ®Šæ¬Šé™**
   - å¯¦ç¾åŸºæ–¼ `users.organization` æ¬„ä½çš„è³‡æ–™ç¯„åœæŸ¥è©¢
   - CLIENT è§’è‰²ä¸­ï¼Œå¦‚æœç”¨æˆ¶æ˜¯ä¸»ç®¡ï¼Œå¯æŸ¥çœ‹åŒçµ„ç¹”ä¸‹æ‰€æœ‰ç”¨æˆ¶çš„è¨ˆç•«
   - éœ€è¦åœ¨å‰ç«¯æˆ–å¾Œç«¯é‚è¼¯ä¸­è­˜åˆ¥ã€Œä¸»ç®¡ã€èº«ä»½ï¼ˆå¯èƒ½éœ€è¦é¡å¤–æ¬„ä½ï¼‰

---

## åƒè€ƒè³‡æ–™

- æ¬Šé™å®šç¾©ï¼š`backend/migrations/011_reorganize_permissions.sql`
- è§’è‰²å®šç¾©ï¼š`backend/migrations/002_extend_schema.sql`
- IACUC_STAFF æ¬Šé™ï¼š`backend/migrations/010_assign_iacuc_staff_permissions.sql`
- è±¬éš»æ¬Šé™ï¼š`backend/migrations/004_pig_frontend_requirements.sql`
